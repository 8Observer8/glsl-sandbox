<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
	<title>GLSL Sandbox Diff</title>
	<link rel="stylesheet" type="text/css" href="css/diffview.css"/>
	<script type="text/javascript" src="js/difflib.js"></script>
	<script type="text/javascript" src="js/diffview.js"></script>
	<script type="text/javascript" src='js/jquery.js'></script>
<style type="text/css">
body {
	font-size: 12px;
	font-family: Sans-Serif;
}
h2 {
	margin: 0.5em 0 0.1em;
}
a, a:visited {
	text-decoration: none;
}
a:focus, a:hover {
	text-decoration: underline;
}
label:hover {
	text-decoration: underline;
	cursor: pointer;
}
table.diff {
	white-space: pre-wrap;
}
.top {
	text-align: center;
}
.textInput {
	display: block;
	width: 49%;
	float: left;
}
.spacer {
	margin-left: 10px;
}
#diffoutput {
	width: 100%;
	margin-top: 1em;
}
</style>

<script type="text/javascript">
var leftSide = { id: '', code: '', name: '', parent: null, loaded: false },
	rightSide = { id: '', code: '', name: '', parent: null, loaded: false },
	viewTypes = { sideBySide: 0, viewInline: 1 };

function showDiff(viewType) {
	var leftText = difflib.stringAsLines(leftSide.code);
	var rightText = difflib.stringAsLines(rightSide.code);
	var sm = new difflib.SequenceMatcher(leftText, rightText);
	var opcodes = sm.get_opcodes();
	var diffoutputdiv = document.getElementById("diffoutput");
	diffoutputdiv.innerHTML = "";
	diffoutputdiv.appendChild(diffview.buildView({
		baseTextLines: leftText,
		newTextLines: rightText,
		opcodes: opcodes,
		baseTextName: leftSide.name,
		newTextName: rightSide.name,
		contextSize: null,
		viewType: viewType
	}));
}

function computeNames() {
	if (!leftSide.loaded) {
		leftSide.name = 'Not loaded';
	} else if (rightSide.parent.substring(3) === leftSide.id) {
		leftSide.name = 'parent effect ' + leftSide.id;
	} else {
		leftSide.name = 'effect ' + leftSide.id;
	}

	if (!rightSide.loaded) {
		rightSide.name = 'Not loaded';
	} else if (leftSide.parent.substring(3) === rightSide.id) {
		rightSide.name = 'parent effect ' + rightSide.id;
	} else {
		rightSide.name = 'effect ' + rightSide.id;
	}
	
	document.getElementById('subtitle').innerHTML =
		'<a href="e#' + leftSide.id + '">' + leftSide.name + '</a> vs. ' +
		'<a href="e#' + rightSide.id + '">' + rightSide.name + '</a>';
}

function load_code(side) {
	$.getJSON('item/'+side.id, function(result) {
		side.code = result.code;
		side.parent = result.parent;
		side.loaded = true;
		if (leftSide.loaded && rightSide.loaded) {
			computeNames();
			showDiff(viewTypes.sideBySide);
		}
	}).error(function (jqXHR, textStatus, errorThrown) {
		alert(textStatus);
	});
}

function onHashChange() {
	// hash format: #a-vs-b
	var hash = window.location.hash,
		pos = hash.indexOf('-vs-'),
		newLeftID = null,
		newRightID = null;

	document.getElementById('subtitle').innerHTML = '&nbsp;';

	if ((pos < 2) || ((hash.length - pos) < 5)) {
		leftSide.loaded = rightSide.loaded = false;
		leftSide.name = rightSide.name = 'invalid';
		leftSide.code = rightSide.code = 'invalid';
		leftSide.parent = rightSide.parent = null;
		document.getElementById("diffoutput").innerHTML = "Invalid Diff URL.";
	} else {
		newLeftID = hash.substring(1, pos);
		newRightID = hash.substring(pos + 4);
		if (newLeftID !== leftSide.id) {
			leftSide.id = newLeftID;
			leftSide.name = 'Loading...';
			leftSide.code = '';
			leftSide.parent = null;
			leftSide.loaded = false;
		}
		if (newRightID !== rightSide.id) {
			rightSide.id = newRightID;
			rightSide.name = 'Loading...';
			rightSide.code = '';
			rightSide.parent = null;
			rightSide.loaded = false;
		}
		if (!(leftSide.loaded && rightSide.loaded)) {
			document.getElementById("diffoutput").innerHTML = "Loading...";
			if (!leftSide.loaded) {
				load_code(leftSide);
			}
			if (!rightSide.loaded) {
				load_code(rightSide);
			}
		}
	}
}

// on DOM ready
$(function () {
	window.onhashchange = function () { onHashChange(); };
	onHashChange();
});

</script>
</head>
<body>
	<h1 class="top"><a href="/">GLSL Sandbox</a> Diff</h1>
	<h2 class="top" id="subtitle">&nbsp;</h2>
	<div class="top">
		<input type="radio" name="_viewtype" checked="checked" id="sidebyside" onclick="showDiff(0);" />
		<label for="sidebyside">Side-by-side diff</label>
		&nbsp; &nbsp;
		<input type="radio" name="_viewtype" id="inline" onclick="showDiff(1);" />
		<label for="inline">Inline diff</label>
	</div>
	<div id="diffoutput">Loading...</div>
</body>
</html>
